<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Tournament Scoreboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { background: #0b1220; }
    .glass { backdrop-filter: blur(8px); background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.06)); }
  </style>
</head>
<body class="min-h-screen text-slate-100">
  <header class="max-w-6xl mx-auto px-4 py-6">
    <div class="flex items-center justify-between">
      <h1 class="text-2xl md:text-3xl font-bold tracking-tight">⚽ Live Tournament Scoreboard</h1>
      <div class="text-xs md:text-sm opacity-75">Realtime via Firebase</div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-24">
    <!-- Card: Match controls -->
    <section class="glass rounded-2xl shadow-xl border border-white/10 p-4 md:p-6">
      <div class="flex flex-col md:flex-row gap-3 md:items-center">
        <div class="flex-1">
          <label for="matchSelect" class="block text-sm font-semibold mb-1">Current match</label>
          <select id="matchSelect" class="w-full rounded-xl bg-slate-900/60 border border-white/10 px-3 py-2 text-slate-100 focus:outline-none focus:ring-2 focus:ring-indigo-400"></select>
        </div>
        <div class="flex gap-2">
          <button id="newMatchBtn" class="rounded-xl px-4 py-2 bg-indigo-500 hover:bg-indigo-400 font-semibold">New Match</button>
          <button id="deleteMatchBtn" class="rounded-xl px-4 py-2 bg-rose-600 hover:bg-rose-500 font-semibold">Delete</button>
        </div>
      </div>
    </section>

    <!-- Card: Teams + Score -->
    <section class="grid md:grid-cols-3 gap-6 mt-6">
      <!-- Team A -->
      <div class="glass rounded-2xl p-5 border border-white/10">
        <div class="text-center">
          <label class="text-xs uppercase tracking-wide opacity-70">Team A</label>
          <input id="team1Input" class="mt-1 w-full text-center text-xl md:text-2xl font-bold bg-transparent border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-400" placeholder="Team A" />
        </div>
        <div class="mt-5 flex items-center justify-center gap-3">
          <button data-team="team1" data-delta="-1" class="score-btn rounded-xl px-4 py-2 bg-slate-800 hover:bg-slate-700">−</button>
          <div class="text-5xl font-black tabular-nums" id="team1Score">0</div>
          <button data-team="team1" data-delta="1" class="score-btn rounded-xl px-4 py-2 bg-slate-800 hover:bg-slate-700">＋</button>
        </div>
      </div>

      <!-- Center -->
      <div class="glass rounded-2xl p-5 border border-white/10 flex flex-col items-center justify-center text-center">
        <div class="text-4xl font-black">VS</div>
        <div class="mt-2 text-xs opacity-70">Match clock (optional)</div>
        <div class="mt-2">
          <button id="resetBtn" class="rounded-xl px-4 py-2 bg-slate-800 hover:bg-slate-700">Reset Scores</button>
        </div>
      </div>

      <!-- Team B -->
      <div class="glass rounded-2xl p-5 border border-white/10">
        <div class="text-center">
          <label class="text-xs uppercase tracking-wide opacity-70">Team B</label>
          <input id="team2Input" class="mt-1 w-full text-center text-xl md:text-2xl font-bold bg-transparent border border-white/10 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-400" placeholder="Team B" />
        </div>
        <div class="mt-5 flex items-center justify-center gap-3">
          <button data-team="team2" data-delta="-1" class="score-btn rounded-xl px-4 py-2 bg-slate-800 hover:bg-slate-700">−</button>
          <div class="text-5xl font-black tabular-nums" id="team2Score">0</div>
          <button data-team="team2" data-delta="1" class="score-btn rounded-xl px-4 py-2 bg-slate-800 hover:bg-slate-700">＋</button>
        </div>
      </div>
    </section>

    <!-- Add goal -->
    <section class="glass rounded-2xl p-5 border border-white/10 mt-6">
      <h2 class="text-lg font-semibold">Add a Goal</h2>
      <form id="goalForm" class="grid md:grid-cols-4 gap-3 mt-3">
        <select id="teamSelect" required class="rounded-xl bg-slate-900/60 border border-white/10 px-3 py-2">
          <option value="">Select Team</option>
          <option value="team1">Team A</option>
          <option value="team2">Team B</option>
        </select>
        <input id="scorerInput" required placeholder="Scorer" class="rounded-xl bg-slate-900/60 border border-white/10 px-3 py-2" />
        <input id="assistInput" placeholder="Assist (optional)" class="rounded-xl bg-slate-900/60 border border-white/10 px-3 py-2" />
        <button class="rounded-xl px-4 py-2 bg-emerald-600 hover:bg-emerald-500 font-semibold">Add Goal</button>
      </form>
    </section>

    <!-- Goal lists -->
    <section class="grid md:grid-cols-2 gap-6 mt-6">
      <div class="glass rounded-2xl p-5 border border-white/10">
        <h3 id="teamAStatsTitle" class="font-semibold text-indigo-300">Team A Goals</h3>
        <ul id="teamAStats" class="divide-y divide-white/10 mt-3"></ul>
      </div>
      <div class="glass rounded-2xl p-5 border border-white/10">
        <h3 id="teamBStatsTitle" class="font-semibold text-indigo-300">Team B Goals</h3>
        <ul id="teamBStats" class="divide-y divide-white/10 mt-3"></ul>
      </div>
    </section>
  </main>

  <!-- Firebase + App -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, doc, setDoc, updateDoc, getDoc, addDoc, deleteDoc,
      onSnapshot, query, orderBy, serverTimestamp, increment
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB0DaaYB1hZLY8h23QOpT7Ok4sX5ACkHTM",
      authDomain: "we-are-eleven.firebaseapp.com",
      projectId: "we-are-eleven",
      storageBucket: "we-are-eleven.firebasestorage.app",
      messagingSenderId: "446706356039",
      appId: "1:446706356039:web:db1bd26c20a2571b824662",
      measurementId: "G-M3DSVHMNEV"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentMatchId = null;
    let unsubMatch = null;
    let unsubList = null;

    const els = {
      matchSelect: document.getElementById('matchSelect'),
      newMatchBtn: document.getElementById('newMatchBtn'),
      deleteMatchBtn: document.getElementById('deleteMatchBtn'),
      team1Input: document.getElementById('team1Input'),
      team2Input: document.getElementById('team2Input'),
      team1Score: document.getElementById('team1Score'),
      team2Score: document.getElementById('team2Score'),
      resetBtn: document.getElementById('resetBtn'),
      goalForm: document.getElementById('goalForm'),
      teamSelect: document.getElementById('teamSelect'),
      scorerInput: document.getElementById('scorerInput'),
      assistInput: document.getElementById('assistInput'),
      teamAStats: document.getElementById('teamAStats'),
      teamBStats: document.getElementById('teamBStats'),
      teamAStatsTitle: document.getElementById('teamAStatsTitle'),
      teamBStatsTitle: document.getElementById('teamBStatsTitle')
    };

    function renderMatchData(data) {
      const scores = data?.scores || { team1: 0, team2: 0 };
      const teamNames = data?.teamNames || { team1: 'Team A', team2: 'Team B' };
      const goals = data?.goals || [];

      els.team1Input.value = teamNames.team1;
      els.team2Input.value = teamNames.team2;
      els.team1Score.textContent = scores.team1;
      els.team2Score.textContent = scores.team2;
      els.teamAStatsTitle.textContent = `${teamNames.team1} Goals`;
      els.teamBStatsTitle.textContent = `${teamNames.team2} Goals`;

      [...els.matchSelect.options].forEach(opt => {
        if (opt.value === currentMatchId) {
          opt.textContent = `${teamNames.team1} vs ${teamNames.team2}`;
        }
      });

      els.teamAStats.innerHTML = '';
      els.teamBStats.innerHTML = '';
      goals.forEach((g, i) => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between py-2';
        const time = g.time ? new Date(g.time.seconds ? g.time.seconds * 1000 : g.time).toLocaleTimeString() : '';
        li.innerHTML = `
          <div>
            <div class="font-semibold">${escapeHtml(g.scorer)}</div>
            <div class="text-xs opacity-70">${g.assist ? `Assist: ${escapeHtml(g.assist)} · ` : ''}${time}</div>
          </div>
          <button class="rounded-lg px-2.5 py-1.5 bg-rose-600/90 hover:bg-rose-500 text-sm" data-del-index="${i}">Delete</button>
        `;
        (g.team === 'team1' ? els.teamAStats : els.teamBStats).appendChild(li);
      });

      els.teamAStats.querySelectorAll('button[data-del-index]').forEach(btn => btn.addEventListener('click', onDeleteGoal));
      els.teamBStats.querySelectorAll('button[data-del-index]').forEach(btn => btn.addEventListener('click', onDeleteGoal));
    }

    function escapeHtml(str = '') {
      return str.replace(/[&<>"]+/g, s => ({'&': '&amp;','<': '&lt;','>': '&gt;','"': '&quot;'}[s]));
    }

    function listenToMatchList() {
      if (unsubList) unsubList();
      const q = query(collection(db, 'matches'), orderBy('created', 'desc'));
      unsubList = onSnapshot(q, snap => {
        const currentVal = els.matchSelect.value;
        els.matchSelect.innerHTML = '';
        snap.forEach(d => {
          const data = d.data();
          const opt = document.createElement('option');
          opt.value = d.id;
          opt.textContent = `${data?.teamNames?.team1 || 'Team A'} vs ${data?.teamNames?.team2 || 'Team B'}`;
          els.matchSelect.appendChild(opt);
        });
        const found = [...els.matchSelect.options].some(o => o.value === currentVal);
        if (found) els.matchSelect.value = currentVal;
        if (!els.matchSelect.value && els.matchSelect.options.length) {
          els.matchSelect.selectedIndex = 0;
          selectMatch(els.matchSelect.value);
        }
      });
    }

    function listenToMatchDoc(matchId) {
      if (unsubMatch) unsubMatch();
      if (!matchId) return;
      const ref = doc(db, 'matches', matchId);
      unsubMatch = onSnapshot(ref, snap => {
        if (snap.exists()) renderMatchData(snap.data());
      });
    }

    async function selectMatch(matchId) {
      currentMatchId = matchId;
      listenToMatchDoc(matchId);
    }

    // Create a match from the current inputs.
    // If silent=true, no confirmation prompt.
    async function createMatch({ silent = false } = {}) {
      const nameA = (els.team1Input.value || '').trim();
      const nameB = (els.team2Input.value || '').trim();
      if (!nameA || !nameB) {
        alert('Please enter both team names first.');
        return;
      }
      if (!silent) {
        const ok = confirm(`Create new match with:\n${nameA} vs ${nameB}?`);
        if (!ok) return;
      }
      const col = collection(db, 'matches');
      const docRef = await addDoc(col, {
        teamNames: { team1: nameA, team2: nameB },
        scores: { team1: 0, team2: 0 },
        goals: [],
        created: serverTimestamp(),
        updated: serverTimestamp()
      });
      els.matchSelect.value = docRef.id;
      await selectMatch(docRef.id);
    }

    async function deleteMatch() {
      if (!currentMatchId) return;
      if (!confirm('Delete this match? This cannot be undone.')) return;
      await deleteDoc(doc(db, 'matches', currentMatchId));
      currentMatchId = null;
      if (unsubMatch) unsubMatch();
    }

    async function saveNamesDebounced() {
      if (!currentMatchId) return;
      const ref = doc(db, 'matches', currentMatchId);
      await updateDoc(ref, {
        teamNames: {
          team1: els.team1Input.value.trim() || 'Team A',
          team2: els.team2Input.value.trim() || 'Team B'
        },
        updated: serverTimestamp()
      });
    }

    async function adjustScore(team, delta) {
      if (!currentMatchId) return;
      const ref = doc(db, 'matches', currentMatchId);
      const snap = await getDoc(ref);
      if (!snap.exists()) return;
      const data = snap.data();
      const scores = data.scores || { team1: 0, team2: 0 };
      scores[team] = Math.max(0, (scores[team] || 0) + delta);
      await updateDoc(ref, { scores, updated: serverTimestamp() });
    }

    async function resetScores() {
      if (!currentMatchId) return;
      const ref = doc(db, 'matches', currentMatchId);
      await updateDoc(ref, { scores: { team1: 0, team2: 0 }, goals: [], updated: serverTimestamp() });
    }

    async function addGoal(e) {
      e.preventDefault();
      if (!currentMatchId) return alert('Create or select a match first.');
      const team = els.teamSelect.value;
      const scorer = els.scorerInput.value.trim();
      const assist = els.assistInput.value.trim();
      if (!team || !scorer) return;

      const ref = doc(db, 'matches', currentMatchId);
      const snap = await getDoc(ref);
      if (!snap.exists()) return;

      const data = snap.data();
      const goals = Array.isArray(data.goals) ? [...data.goals] : [];
      const goal = { team, scorer, ...(assist ? { assist } : {}), time: Date.now() };
      goals.push(goal);

      await updateDoc(ref, {
        [`scores.${team}`]: increment(1), // exact nested path; Team B safe
        goals,
        updated: serverTimestamp()
      });

      els.goalForm.reset();
    }

    async function onDeleteGoal(ev) {
      const idx = Number(ev.currentTarget.getAttribute('data-del-index'));
      if (!Number.isFinite(idx) || !currentMatchId) return;
      const ref = doc(db, 'matches', currentMatchId);
      const snap = await getDoc(ref);
      if (!snap.exists()) return;
      const data = snap.data();
      const goals = data.goals || [];
      const g = goals[idx];
      if (!g) return;

      const currentTeamScore = (data.scores?.[g.team] ?? 0);
      const newTeamScore = Math.max(0, currentTeamScore - 1);
      const newScores = { ...(data.scores || { team1:0, team2:0 }), [g.team]: newTeamScore };

      goals.splice(idx, 1);
      await updateDoc(ref, { scores: newScores, goals, updated: serverTimestamp() });
    }

    // ---- Prefill from URL & auto-create / deep-link support ----
    async function readPrefillFromURL() {
      const params = new URLSearchParams(window.location.search);
      const t1 = params.get('team1');
      const t2 = params.get('team2');
      const auto = params.get('auto');        // "1" => auto-create
      const mid = params.get('matchId');      // optional deep link

      if (t1) els.team1Input.value = t1;
      if (t2) els.team2Input.value = t2;

      if (t1) els.teamAStatsTitle.textContent = `${t1} Goals`;
      if (t2) els.teamBStatsTitle.textContent = `${t2} Goals`;

      if (mid) {
        // Deep-link to existing match takes precedence
        await selectMatch(mid);
        return;
      }

      if (t1 && t2 && auto === '1') {
        // Create silently from provided names
        await createMatch({ silent: true });
      }
    }

    // ===================== Event listeners =====================
    els.newMatchBtn.addEventListener('click', () => createMatch({ silent: false }));
    els.deleteMatchBtn.addEventListener('click', deleteMatch);
    els.matchSelect.addEventListener('change', (e) => selectMatch(e.target.value));

    let nameTimer = null;
    function queueNameSave() {
      clearTimeout(nameTimer);
      nameTimer = setTimeout(saveNamesDebounced, 400);
    }
    els.team1Input.addEventListener('input', queueNameSave);
    els.team2Input.addEventListener('input', queueNameSave);

    document.querySelectorAll('.score-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const team = btn.getAttribute('data-team');
        const delta = Number(btn.getAttribute('data-delta')) || 0;
        adjustScore(team, delta);
      });
    });

    els.resetBtn.addEventListener('click', resetScores);
    els.goalForm.addEventListener('submit', addGoal);

    // bootstrap
    await readPrefillFromURL();
    listenToMatchList();
  </script>
</body>
</html>
